name: WhatsApp Deployment Notification

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    # Only run for merged PRs or direct pushes to main
    if: github.event_name == 'push' || github.event.pull_request.merged == true

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Send WhatsApp Notification
        env:
          WHATSAPP_TOKEN: ${{ secrets.WHATSAPP_TOKEN }}
          WHATSAPP_PHONE_ID: ${{ secrets.WHATSAPP_PHONE_ID }}
          RECIPIENT_PHONE: ${{ secrets.RECIPIENT_PHONE }}
        run: |
          # Extract commit information
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            COMMIT_MSG="${{ github.event.pull_request.title }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            COMMIT_URL="${{ github.event.pull_request.html_url }}"
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            AUTHOR="${{ github.event.head_commit.author.name }}"
            COMMIT_URL="${{ github.event.head_commit.url }}"
          fi

          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"

          # Escape special characters for JSON
          COMMIT_MSG_ESCAPED=$(echo "$COMMIT_MSG" | sed 's/"/\\"/g' | sed "s/'/\\'/g")

          # Build message body
          MESSAGE_BODY="üöÄ *Deployment Alert*

*Repository:* $REPO
*Branch:* $BRANCH
*Author:* $AUTHOR
*Commit:* $COMMIT_MSG_ESCAPED

$COMMIT_URL"

          # Create JSON payload using jq for proper escaping
          JSON_PAYLOAD=$(jq -n \
            --arg msg_product "whatsapp" \
            --arg recipient "$RECIPIENT_PHONE" \
            --arg msg_type "text" \
            --arg body "$MESSAGE_BODY" \
            '{
              messaging_product: $msg_product,
              to: $recipient,
              type: $msg_type,
              text: {
                preview_url: true,
                body: $body
              }
            }')

          echo "Sending notification..."
          echo "Payload: $JSON_PAYLOAD"

          # Send to WhatsApp Cloud API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://graph.facebook.com/v18.0/${WHATSAPP_PHONE_ID}/messages" \
            -H "Authorization: Bearer ${WHATSAPP_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          # Extract HTTP status code
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_CODE"

          # Check if successful
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ WhatsApp notification sent successfully!"
          else
            echo "‚ùå Failed to send WhatsApp notification"
            echo "Response body: $BODY"
            exit 1
          fi
